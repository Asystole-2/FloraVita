{% extends "layout.html" %}
{% block body %}
<div class="liquid-bg">
    <div class="liquid-blob blob-blue-1"></div>
    <div class="liquid-blob blob-blue-2"></div>
    <div class="liquid-blob blob-green-1"></div>
    <div class="liquid-blob blob-green-2"></div>
    <div class="liquid-blob blob-green-3"></div>
    <div class="liquid-blob blob-purple-1"></div>
    <div class="liquid-blob blob-purple-2"></div>
    <div class="liquid-blob blob-accent"></div>
</div>

<div class="mt-8 relative z-10 px-6">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
        <h1 class="text-4xl font-black tracking-tighter text-white">My Garden</h1>

        {% if plants %}
        <div class="relative w-full md:w-72">
            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
            <input type="text"
                   id="plant-search"
                   onkeyup="filterPlants()"
                   placeholder="Search plants..."
                   class="w-full bg-white/5 border border-white/10 rounded-2xl py-3 pl-11 pr-4 text-white text-xs outline-none focus:ring-1 focus:ring-blue-500/50 transition-all placeholder:text-gray-500">
        </div>
        {% endif %}
    </div>

    <div id="no-results" class="hidden text-center py-20">
        <i class="fas fa-seedling text-gray-600 text-4xl mb-4"></i>
        <p class="text-gray-500 uppercase tracking-widest text-[10px] font-bold">No botanical matches found</p>
    </div>

    <div class="garden-grid pb-10" id="garden-container">
        {% if plants %}
        {% for plant in plants %}
        <div class="plant-card group relative"
             data-card-id="{{ plant.id }}"
             onclick="openPlantDetail({{ plant.id }}, '{{ plant.name }}', '{{ plant.location or 'Lab' }}', '{{ plant.last_moisture or 0 }}', '{{ url_for('static', filename='uploads/' + (plant.image_url or 'default_plant.png')) }}', {{ plant.moisture_threshold or 30 }})">

            <div class="relative overflow-hidden h-48 bg-white/5 flex items-center justify-center">
                <i class="fas fa-leaf text-blue-500/20 text-4xl absolute z-0"></i>
                <img src="{{ url_for('static', filename='uploads/' + (plant.image_url or 'default_plant.png')) }}"
                     class="plant-img relative z-10 transition-transform duration-700 group-hover:scale-110"
                     onerror="this.style.display='none'">
                <div class="absolute inset-0 z-20 bg-gradient-to-t from-[#020617] to-transparent opacity-60"></div>
                <div class="absolute top-4 right-4 z-30 status-pill bg-black/40 backdrop-blur-md border-white/10">
                    <i class="fas fa-map-marker-alt text-[10px] mr-1"></i>
                    <span class="text-[9px] uppercase tracking-widest">{{ plant.location or 'Lab' }}</span>
                </div>
            </div>

            <div class="p-6">
                <h3 class="text-xl font-bold text-white group-hover:text-blue-400 transition-colors">{{ plant.name
                    }}</h3>
                <p class="text-[10px] text-gray-500 uppercase tracking-widest mt-1 mb-4">
                    Last Sync: {{ plant.last_update.strftime('%H:%M') if plant.last_update else 'N/A' }}
                </p>
                <div class="space-y-3">
                    <div class="flex justify-between items-center text-[11px] font-bold uppercase tracking-widest">
                        <span class="text-gray-400">Moisture</span>
                        <span class="text-blue-400">{{ plant.last_moisture or 0 }}%</span>
                    </div>
                    <div class="h-1.5 w-full bg-white/5 rounded-full overflow-hidden border border-white/5">
                        <div class="h-full bg-gradient-to-r from-blue-600 to-cyan-400 shadow-[0_0_10px_#3b82f6] transition-all duration-1000"
                             style="width: {{ plant.last_moisture or 0 }}%"></div>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-white/5 opacity-0 group-hover:opacity-100 transition-all duration-500 transform translate-y-2 group-hover:translate-y-0">
                    <div class="flex justify-between items-center">
                            <span id="threshold-display-{{ plant.id }}"
                                  class="text-[9px] text-gray-500 uppercase tracking-tighter">
                                Threshold: {{ plant.moisture_threshold }}%
                            </span>
                        <i class="fas fa-chevron-right text-blue-500 text-xs"></i>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <a href="{{ url_for('settings') }}"
           class="plant-card group relative flex flex-col items-center justify-center p-12 border-dashed border-2 border-white/10 hover:border-blue-500/50 transition-all">
            <div class="w-20 h-20 bg-blue-500/10 rounded-full flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
                <i class="fas fa-plus text-blue-400 text-3xl"></i>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">Your Garden is Empty</h3>
            <p class="text-gray-400 text-center text-xs max-w-[200px] leading-relaxed">
                Head to settings to register your first botanical device.
            </p>
            <div class="mt-6 px-6 py-2 bg-blue-600 rounded-full text-[10px] font-bold uppercase tracking-widest text-white">
                Register Plant
            </div>
        </a>
        {% endif %}
    </div>
</div>
{% include "components/plant_modal.html" %}

<script>
    // Global State
    let currentPlantId = null;
    let pumpActive = false;

    /**
     * Updates all notification badges on the page in real-time
     * Ensures the user sees the alert dot and the menu glow immediately.
     */
    function incrementNotificationBadge() {
        const badges = document.querySelectorAll('.notification-dot');
        const nav = document.getElementById('main-nav');
        const collapsedBadge = document.getElementById('collapsed-badge');

        // Trigger the glowing alert animation on the menu
        if (nav) nav.classList.add('nav-glow');

        badges.forEach(badge => {
            let currentCount = parseInt(badge.innerText) || 0;
            badge.innerText = currentCount + 1;
            badge.classList.remove('hidden'); // Ensure it's visible
            badge.style.display = 'flex';
        });

        // If menu is collapsed, ensure the specific collapsed badge is visible
        if (collapsedBadge && !nav.classList.contains('expanded')) {
            collapsedBadge.style.display = 'flex';
        }
    }

    /**
     * Logic to handle automatic photo updates when a file is selected
     */
    function submitPhotoUpdate() {
        const form = document.getElementById('modal-photo-form');
        if (form) {
            console.log("Photo change detected, submitting form...");
            form.submit();
        }
    }

    /**
     * Synchronizes the Range Slider and Numeric Input locally
     */
    function syncThresholdUI() {
        const slider = document.getElementById('threshold-slider');
        const num = document.getElementById('threshold-num');

        if (slider && num) {
            slider.oninput = (e) => {
                num.value = e.target.value;
            };
            num.oninput = (e) => {
                slider.value = e.target.value;
            };
        }
    }

    /**
     * Persists the threshold to the database and updates the dashboard UI
     */
    async function saveThresholdToDB() {
        if (!currentPlantId) return;

        const val = document.getElementById('threshold-slider').value;
        const btn = document.getElementById('save-threshold-btn');
        const originalIcon = btn.innerHTML;

        try {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            const response = await fetch(`/update-threshold/${currentPlantId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({threshold: parseInt(val)})
            });

            if (response.ok) {
                btn.innerHTML = '<i class="fas fa-check-double text-white"></i>';
                btn.classList.add('bg-emerald-600');

                // Update Card UI
                const displaySpan = document.getElementById(`threshold-display-${currentPlantId}`);
                if (displaySpan) displaySpan.innerText = `Threshold: ${val}%`;

                const card = document.querySelector(`[data-card-id="${currentPlantId}"]`);
                if (card) {
                    const currentOnClick = card.getAttribute('onclick');
                    const newOnClick = currentOnClick.replace(/, \d+\)$/, `, ${val})`);
                    card.setAttribute('onclick', newOnClick);
                }

                // Real-time notification update
                incrementNotificationBadge();

                setTimeout(() => {
                    btn.innerHTML = originalIcon;
                    btn.classList.remove('bg-emerald-600');
                }, 2000);
            }
        } catch (err) {
            console.error("Save failed:", err);
            btn.innerHTML = originalIcon;
        }
    }

    /**
     * Opens the plant modal and populates telemetry
     */
    async function openPlantDetail(id, name, location, moisture, img, threshold) {
        currentPlantId = id;
        const modal = document.getElementById('plant-modal');
        const modalImg = document.getElementById('modal-img');
        const fallback = document.getElementById('modal-img-fallback');

        const slider = document.getElementById('threshold-slider');
        const num = document.getElementById('threshold-num');
        if (slider && num) {
            slider.value = threshold;
            num.value = threshold;
        }

        setTimeout(() => syncThresholdUI(), 100);

        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        document.getElementById('modal-title').innerText = name;
        document.getElementById('modal-location').innerText = location;
        document.getElementById('modal-moisture').innerText = moisture + '%';

        const photoForm = document.getElementById('modal-photo-form');
        if (photoForm) photoForm.action = `/update-plant-photo/${id}`;

        fallback.classList.add('hidden');
        modalImg.classList.remove('hidden');
        modalImg.src = img;

        document.querySelectorAll('.ai-content-compact').forEach(p => p.innerText = "Synthesizing intel...");
        try {
            const response = await fetch(`/api/ai-tips/${id}`);
            const data = await response.json();
            document.getElementById('ai-watering').innerText = data.watering || "No strategy.";
            document.getElementById('ai-lighting').innerText = data.lighting || "Analyzing light.";
            document.getElementById('ai-fertilization').innerText = data.fertilization || "Checking nutrients.";
            document.getElementById('ai-other').innerText = data.other || "Maintenance logs clear.";
        } catch (err) {
            document.querySelectorAll('.ai-content-compact').forEach(p => p.innerText = "Offline.");
        }
    }

    /**
     * Manual Irrigation Toggle with Backend Sync
     */
    async function togglePump() {
        const btn = document.getElementById('pump-control-btn');
        if (!currentPlantId) return;

        pumpActive = !pumpActive;

        if (pumpActive) {
            btn.innerHTML = '<i class="fas fa-stop mr-2"></i> Stop Pump';
            btn.className = "flex-[2] py-4 bg-red-600 hover:bg-red-500 text-white rounded-2xl text-[10px] font-bold uppercase tracking-widest transition-all shadow-lg shadow-red-900/40";
        } else {
            btn.innerHTML = '<i class="fas fa-play mr-2"></i> Start Pump';
            btn.className = "flex-[2] py-4 bg-blue-600 hover:bg-blue-500 text-white rounded-2xl text-[10px] font-bold uppercase tracking-widest transition-all shadow-lg shadow-blue-900/40";
        }

        try {
            const response = await fetch(`/toggle-pump/${currentPlantId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({active: pumpActive})
            });

            if (response.ok) {
                // Update notification badge on every toggle action
                incrementNotificationBadge();
            }
        } catch (err) {
            console.error("Network error during pump toggle:", err);
        }
    }

    /**
     * Persists name and location changes and updates UI instantly
     */
    async function saveIdentity() {
        const newName = document.getElementById('edit-name-input').value;
        const newLoc = document.getElementById('edit-location-input').value;

        if (!newName.trim()) {
            alert("Plant name cannot be empty.");
            return;
        }

        try {
            const response = await fetch(`/update-plant-info/${currentPlantId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: newName, location: newLoc})
            });

            if (response.ok) {
                document.getElementById('modal-title').innerText = newName;
                document.getElementById('modal-location').innerText = newLoc;

                const card = document.querySelector(`[data-card-id="${currentPlantId}"]`);
                if (card) {
                    card.querySelector('h3').innerText = newName;
                    const statusPill = card.querySelector('.status-pill span');
                    if (statusPill) statusPill.innerText = newLoc || 'Lab';

                    const currentOnClick = card.getAttribute('onclick');
                    const parts = currentOnClick.split("', '");
                    if (parts.length >= 2) {
                        const firstPart = parts[0].split(", '");
                        firstPart[1] = newName;
                        parts[0] = firstPart.join(", '");
                        parts[1] = newLoc || 'Lab';
                        card.setAttribute('onclick', parts.join("', '"));
                    }
                }
                toggleEditIdentity(false);
            }
        } catch (err) {
            console.error("Identity Sync Error:", err);
        }
    }

    /**
     * Polling logic to catch automated background notifications
     * Runs every 30 seconds.
     */
    setInterval(async () => {
        try {
            const response = await fetch('/api/unread-count');
            const data = await response.json();
            const badges = document.querySelectorAll('.notification-dot');
            const nav = document.getElementById('main-nav');

            if (data.count > 0) {
                badges.forEach(b => {
                    b.innerText = data.count;
                    b.style.display = 'flex';
                    b.classList.remove('hidden');
                });
                if (nav) nav.classList.add('nav-glow');
            } else {
                if (nav) nav.classList.remove('nav-glow');
                badges.forEach(b => b.style.display = 'none');
            }
        } catch (e) { print("Error fetching unread count:")
        }
    }, 30000);

    // Standard UI Helpers
    function handleImgError() {
        document.getElementById('modal-img').classList.add('hidden');
        document.getElementById('modal-img-fallback').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('plant-modal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    function closeConfirm() {
        document.getElementById('confirm-modal').classList.add('hidden');
    }

    function toggleEditIdentity(isEditing) {
        const display = document.getElementById('display-identity');
        const edit = document.getElementById('edit-identity');
        const nameInput = document.getElementById('edit-name-input');
        if (isEditing) {
            nameInput.value = document.getElementById('modal-title').innerText;
            document.getElementById('edit-location-input').value = document.getElementById('modal-location').innerText;
            updateCharCount(nameInput);
            display.classList.add('hidden');
            edit.classList.remove('hidden');
        } else {
            display.classList.remove('hidden');
            edit.classList.add('hidden');
        }
    }

    function updateCharCount(input) {
        const counter = document.getElementById('char-counter');
        counter.innerText = `${input.value.length}/20`;
    }

    function toggleAccordion(btn) {
        const panel = btn.nextElementSibling;
        const icon = btn.querySelector('.fa-plus');
        const isOpen = panel.classList.contains('open');
        document.querySelectorAll('.accordion-panel').forEach(p => p.classList.remove('open'));
        document.querySelectorAll('.fa-plus').forEach(i => i.style.transform = "rotate(0deg)");
        if (!isOpen) {
            panel.classList.add('open');
            icon.style.transform = "rotate(45deg)";
        }
    }
    /**
 * Filters the garden grid based on search input
 */
function filterPlants() {
    const input = document.getElementById('plant-search');
    const filter = input.value.toLowerCase();
    const container = document.getElementById('garden-container');
    const cards = container.getElementsByClassName('plant-card');
    const noResults = document.getElementById('no-results');
    let hasMatch = false;

    for (let i = 0; i < cards.length; i++) {
        // Find the plant name (h3) inside the card
        const title = cards[i].querySelector('h3');
        if (title) {
            const textValue = title.textContent || title.innerText;
            if (textValue.toLowerCase().indexOf(filter) > -1) {
                cards[i].style.display = "";
                hasMatch = true;
            } else {
                cards[i].style.display = "none";
            }
        }
    }

    // Toggle the "No results" message
    if (noResults) {
        if (hasMatch || filter === "") {
            noResults.classList.add('hidden');
        } else {
            noResults.classList.remove('hidden');
        }
    }
}

/**
 * Opens a confirmation dialog for destructive actions
 * @param {string} type - Either 'plant' or 'photo'
 */
function confirmDeletion(type) {
    const confirmModal = document.getElementById('confirm-modal');
    const confirmTitle = document.getElementById('confirm-title');
    const actionBtn = document.getElementById('confirm-action-btn');

    if (!confirmModal || !confirmTitle || !actionBtn) return;

    confirmModal.classList.remove('hidden');

    if (type === 'plant') {
        confirmTitle.innerText = "Delete Plant?";
        // Direct the confirmation button to the delete-plant route
        actionBtn.onclick = () => {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/delete-plant/${currentPlantId}`;
            document.body.appendChild(form);
            form.submit();
        };
    } else if (type === 'photo') {
        confirmTitle.innerText = "Remove Photo?";
        actionBtn.onclick = () => {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/remove-plant-photo/${currentPlantId}`;
            document.body.appendChild(form);
            form.submit();
        };
    }
}

/**
 * Poll for moisture updates every 5 seconds
 */
let moisturePollInterval = null;

function setupMoisturePolling() {
    console.log('Setting up moisture polling...');

    // Clear any existing interval
    if (moisturePollInterval) {
        clearInterval(moisturePollInterval);
    }

    // Poll every 2 seconds
    moisturePollInterval = setInterval(pollMoistureData, 2000);

    // First poll after 1 second
    setTimeout(pollMoistureData, 1000);
}

async function pollMoistureData() {
    try {
        const response = await fetch('/api/latest-moisture');

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();

        if (data.success && data.updates) {
            // Update each plant card
            data.updates.forEach(update => {
                updatePlantCardMoisture(
                    update.plant_id,
                    update.moisture,
                    update.timestamp
                );
            });

            console.log(` Updated ${data.updates.length} plants`);
        }
    } catch (error) {
        console.log('ðŸ“¡ Polling failed (will retry):', error.message);
    }
}

/**
 * Update plant card with new moisture data
 */
function updatePlantCardMoisture(plantId, moisture, timestamp) {
    // Find the plant card
    const card = document.querySelector(`[data-card-id="${plantId}"]`);
    if (!card) return;

    // Update moisture percentage
    const moistureSpan = card.querySelector('.text-blue-400');
    if (moistureSpan) {
        moistureSpan.textContent = `${moisture}%`;
    }

    // Update progress bar
    const progressBar = card.querySelector('.h-full');
    if (progressBar) {
        progressBar.style.width = `${moisture}%`;

        // Change color based on moisture level
        if (moisture < 30) {
            progressBar.className = 'h-full bg-gradient-to-r from-red-600 to-orange-400 shadow-[0_0_10px_#ef4444] transition-all duration-1000';
        } else if (moisture < 60) {
            progressBar.className = 'h-full bg-gradient-to-r from-yellow-600 to-yellow-400 shadow-[0_0_10px_#eab308] transition-all duration-1000';
        } else {
            progressBar.className = 'h-full bg-gradient-to-r from-blue-600 to-cyan-400 shadow-[0_0_10px_#3b82f6] transition-all duration-1000';
        }
    }

    // Update timestamp
    const timestampElement = card.querySelector('.text-gray-500');
    if (timestampElement && timestamp) {
        const date = new Date(timestamp);
        timestampElement.textContent = `Last Sync: ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
    }

    // Update modal if it's open for this plant
    if (currentPlantId === plantId) {
        const modalMoisture = document.getElementById('modal-moisture');
        if (modalMoisture) {
            modalMoisture.textContent = `${moisture}%`;
        }
    }
}

// Start polling when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('FloraVita Dashboard loaded');
    setupMoisturePolling();
});
</script>
{% endblock %}